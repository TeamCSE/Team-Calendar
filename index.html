<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSE CALENDAR</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #4a90e2; 
            --primary-hover: #357abd; 
            --event-green: #5cb85c; 
            --delete-red: #d9534f; 
            --bg: #f4f7f6; 
            --border: #eee; 
            --error-red: #ff4d4d; 
            --notice-bg: #fff3cd;
            --notice-text: #856404;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .main-wrapper { display: flex; width: 100%; height: 100%; }

        /* Notice Banner */
        .notice-banner {
            width: 100%;
            background: var(--notice-bg);
            color: var(--notice-text);
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid #ffeeba;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .refresh-btn {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            border: none;
            transition: background 0.2s;
        }
        .refresh-btn:hover { background: var(--primary-hover); }

        /* Layout Sections */
        .calendar-section { flex: 3; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .calendar-container { width: 95%; max-width: 900px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; margin-top: 20px; }
        .event-pane { flex: 1; background: #ffffff; border-left: 1px solid #ddd; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
		.text-box { width: 316px; }

        /* Grid UI */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #fff; }
        .month-display { font-size: 24px; font-weight: bold; color: #333; }
        .day-header { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--primary); color: white; text-align: center; font-size: 12px; font-weight: bold; }
        .day-header div { padding: 12px 0; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #fff; }
        .day { min-height: 120px; padding: 10px; border: 0.5px solid var(--border); cursor: pointer; transition: all 0.2s ease; position: relative; }
        .day:hover { background-color: #f0f7ff; box-shadow: inset 0 0 0 2px var(--primary); z-index: 2; }
        .today { background: #eef6ff !important; font-weight: bold; }
        .today::after { content: "TODAY"; font-size: 9px; position: absolute; top: 5px; right: 5px; background: var(--primary); color: white; padding: 1px 4px; border-radius: 3px; }
        .outside { background: #fafafa; color: #ccc; cursor: default; }

        /* Log UI */
        .log-item { padding: 12px 10px; border-radius: 0 4px 4px 0; margin-bottom: 8px; font-size: 12px; background: #fdfdfd; border-left: 4px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .log-add { border-left-color: var(--event-green); }
        .log-delete { border-left-color: var(--delete-red); }

        /* Pills & Tooltips restored */
        .calendar-pill { background: var(--event-green); color: white; font-size: 11px; padding: 6px 8px; border-radius: 4px; margin-top: 5px; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .pill-tooltip {
            visibility: hidden; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background-color: #333; color: #fff; text-align: center; padding: 6px 10px; border-radius: 6px;
            white-space: nowrap; font-size: 10px; z-index: 100; opacity: 0; transition: opacity 0.2s;
        }
        .pill-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .calendar-pill:hover .pill-tooltip { visibility: visible; opacity: 1; }
        .pill-delete { cursor: pointer; font-weight: bold; font-size: 14px; margin-left: 8px; opacity: 0.6; }
        .pill-delete:hover { opacity: 1; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 340px; }
        input, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { cursor: pointer; border-radius: 4px; border: none; font-weight: 600; padding: 8px 15px; }
        .error-msg { color: var(--error-red); font-size: 11px; margin-bottom: 10px; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="calendar-section">
        <div class="notice-banner">
            <span>Notice: Please refresh the page to ensure it is up to date before filling a leave request.</span>
            <button class="refresh-btn" onclick="window.location.reload()">Refresh Page</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)" style="background:var(--primary); color:white;">Prev</button>
                <div id="monthDisplay" class="month-display"></div>
                <button onclick="changeMonth(1)" style="background:var(--primary); color:white;">Next</button>
            </div>
            <div class="day-header">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendarGrid" class="days-grid"></div>
        </div>
        <div style="width:100%; max-width:900px; text-align:center; margin-top:20px; color:#7f8c8d; font-size:13px; font-style:italic;">
          <b>This calendar page was created to provide the team with clear visibility into scheduled Leave and PTO.</b>
        </div>
    </div>
    
    <div class="event-pane">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <h2 style="font-size: 18px; margin:0;">Activity Log <span style="font-size: 10px;">(Manila Time)</span></h2>
           <!--<button onclick="openAdminModal()" style="font-size:11px; background:#f8d7da; color:#721c24;">Clear</button>-->
        </div>
        <div id="paneList" style="margin-top: 15px;"></div>
    </div>
</div>

<div id="eventModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">Add Entry</h3>
        <input type="text" class="text-box" maxlength="6" id="eventTitle" placeholder="Name">
		
        <select id="eventShift">
            <option value="" disabled selected>-- Select Shift Time --</option>
            <option value="7 PM">7 PM</option>
            <option value="8 PM">8 PM</option>
            <option value="11 PM">11 PM</option>
            <option value="1 AM">1 AM</option>
            <option value="10 AM">10 AM</option>
        </select>
        <div id="valMsg" class="error-msg">Required fields missing!</div>
        <div id="limitMsg" class="error-msg"></div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeModal('eventModal')">Cancel</button>
            <button onclick="saveEvent()" style="background:var(--primary); color:white;">Save</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Delete Entry?</h3>
        <p id="deletePromptText" style="font-size:14px; color:#555;"></p>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeModal('deleteModal')">Cancel</button>
            <button id="confirmDeleteBtn" style="background:var(--delete-red); color:white;">Confirm</button>
        </div>
    </div>
</div>

<div id="adminModal" class="modal">
    <div class="modal-content">
        <h3>Admin Clear</h3>
        <input type="password" id="adminPassInput" placeholder="Password">
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeModal('adminModal')">Cancel</button>
            <button onclick="verifyAndClearLog()" style="background:var(--delete-red); color:white;">Wipe Logs</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAqqi6YTOIEhMOrkbE2zYT6W315S4wznog",
        authDomain: "web-app-8f476.firebaseapp.com",
        databaseURL: "https://web-app-8f476-default-rtdb.firebaseio.com",
        projectId: "web-app-8f476",
        storageBucket: "web-app-8f476.firebasestorage.app",
        messagingSenderId: "376213417562",
        appId: "1:376213417562:web:8e14ad690f4a2b6a07f263",
        measurementId: "G-N4N5BQ72WZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ADMIN_PW = "Khel";
    let dt = new Date();
    let activeEvents = {};
    let selectedDateKey = null;

    function getManilaTime() { 
        return new Date().toLocaleString('en-US', { 
            timeZone: 'Asia/Manila', month: 'short', day: 'numeric', year: 'numeric', 
            hour: '2-digit', minute: '2-digit', hour12: true 
        }); 
    }

    db.ref('activeEvents').on('value', snap => { activeEvents = snap.val() || {}; renderCalendar(); });
    db.ref('permanentLog').on('value', snap => {
        const paneList = document.getElementById('paneList');
        paneList.innerHTML = '';
        const logs = snap.val() || {};
        Object.keys(logs).reverse().forEach(k => {
            const entry = logs[k];
            const div = document.createElement('div');
            div.className = `log-item ${entry.type==='ADD'?'log-add':'log-delete'}`;
            div.innerHTML = `<strong>${entry.type}: ${entry.title}</strong><br><span style="color:#888; font-size:10px;">Logged: ${entry.timestamp_manila}</span>`;
            paneList.appendChild(div);
        });
    });

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        const month = dt.getMonth(); const year = dt.getFullYear();
        document.getElementById('monthDisplay').innerText = dt.toLocaleDateString('en-us', { month: 'long', year: 'numeric' });
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div class="day outside"></div>';
        for(let d=1; d<=daysInMonth; d++) {
            const key = `${year}-${month+1}-${d}`;
            const div = document.createElement('div'); div.className = 'day'; div.innerHTML = `<strong>${d}</strong>`;
            if(d===new Date().getDate() && month===new Date().getMonth()) div.classList.add('today');
            if(activeEvents[key]) {
                Object.keys(activeEvents[key]).forEach(id => {
                    const ev = activeEvents[key][id];
                    const p = document.createElement('div'); p.className = 'calendar-pill';
                    // RESTORED TOOLTIP LOGIC HERE
                    p.innerHTML = `<span>${ev.title}</span><div class="pill-tooltip">Shift: ${ev.shift}</div><span class="pill-delete" onclick="event.stopPropagation(); openDeleteModal('${key}','${id}','${ev.title}')">Ã—</span>`;
                    div.appendChild(p);
                });
            }
            div.onclick = () => { selectedDateKey = key; openModal('eventModal'); };
            grid.appendChild(div);
        }
    }

    function openModal(id) { 
        document.getElementById(id).style.display='flex'; 
        document.getElementById('valMsg').style.display='none';
        document.getElementById('limitMsg').style.display='none';
    }
    
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    function saveEvent() {
        const t = document.getElementById('eventTitle'), s = document.getElementById('eventShift');
        const v = document.getElementById('valMsg'), l = document.getElementById('limitMsg');
        v.style.display='none'; l.style.display='none';
        if(!t.value.trim() || !s.value) { v.style.display='block'; return; }

        const currentDayEvents = activeEvents[selectedDateKey] || {};

        if(s.value === "7 PM" || s.value === "8 PM") {
            let combinedCount = 0;
            Object.values(currentDayEvents).forEach(ev => { if(ev.shift === "7 PM" || ev.shift === "8 PM") combinedCount++; });
            if(combinedCount >= 2) { l.innerText = "Only 2 leaves allowed across 7PM & 8PM shifts combined."; l.style.display = 'block'; return; }
        }

        if(["11 PM", "1 AM", "10 AM"].includes(s.value)) {
            let shiftCount = 0;
            Object.values(currentDayEvents).forEach(ev => { if(ev.shift === s.value) shiftCount++; });
            if(shiftCount >= 1) { l.innerText = `Only 1 leave allowed for the ${s.value} shift.`; l.style.display = 'block'; return; }
        }

        db.ref('activeEvents/'+selectedDateKey).push({ title: t.value, shift: s.value });
        db.ref('permanentLog').push({ type: 'ADD', title: t.value, timestamp_manila: getManilaTime(), timestamp_raw: Date.now() });
        t.value=''; s.selectedIndex=0; closeModal('eventModal');
    }

    function openDeleteModal(k, i, t) {
        document.getElementById('deletePromptText').innerText = `Remove ${t}?`;
        document.getElementById('deleteModal').style.display='flex';
        document.getElementById('confirmDeleteBtn').onclick = () => {
            db.ref(`activeEvents/${k}/${i}`).remove();
            db.ref('permanentLog').push({ type: 'DELETE', title: t, timestamp_manila: getManilaTime(), timestamp_raw: Date.now() });
            closeModal('deleteModal');
        };
    }

    function verifyAndClearLog() { if(document.getElementById('adminPassInput').value === ADMIN_PW) { db.ref('permanentLog').remove(); closeModal('adminModal'); } }
    function changeMonth(v) { dt.setMonth(dt.getMonth()+v); renderCalendar(); }
    function openAdminModal() { document.getElementById('adminModal').style.display='flex'; }
    renderCalendar();
</script>
</body>
</html>

