<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSE CALENDAR</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --primary: #4a90e2; 
            --event-green: #5cb85c; 
            --delete-red: #d9534f; 
            --bg: #f4f7f6; 
            --border: #eee; 
            --notice-bg: #fff3cd;
            --notice-text: #856404;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 11px; 
        }
        
        .main-wrapper { display: flex; width: 100%; height: 100%; }

        .calendar-section { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            overflow-y: auto; 
            position: relative; 
            padding: 0 20px;
        }

        .notice-banner {
            width: 100%; background: var(--notice-bg); color: var(--notice-text);
            padding: 4px; text-align: center; font-size: 10px; font-weight: 600;
            border-bottom: 1px solid #ffeeba; display: flex; justify-content: center; align-items: center; gap: 10px;
        }

        .refresh-btn { background: var(--primary); color: white; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 9px; border: none; }

        .calendar-container { 
            width: 100%; 
            max-width: 850px; 
            background: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border-radius: 6px; 
            overflow: hidden; 
            margin-top: 10px; 
        }

        .event-pane { 
            width: 210px; 
            background: #ffffff; 
            border-left: 1px solid #ddd; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            padding: 10px; 
            box-sizing: border-box;
        }

        .holiday-widget {
            width: 100%;
            background: #fff; 
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 15px;
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto; 
        }

        .holiday-widget h4 { margin: 0 0 6px 0; font-size: 10px; color: #333; text-transform: uppercase; letter-spacing: 0.5px; }
        .holiday-item { font-size: 9px; margin-bottom: 4px; line-height: 1.2; display: flex; align-items: flex-start; gap: 6px; color: #555; }
        .holiday-item b { color: var(--primary); font-size: 8px; min-width: 15px; }

        .log-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .log-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
        }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 6px 15px; background: #fff; }
        .month-display { font-size: 14px; font-weight: bold; color: #333; }
        .day-header { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--primary); color: white; text-align: center; font-size: 9px; font-weight: bold; }
        .day-header div { padding: 4px 0; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: #fff; }
        
        .day { min-height: 75px; padding: 4px; border: 0.5px solid var(--border); cursor: pointer; position: relative; font-size: 10px; }
        .day:hover { background-color: #f0f7ff; }
        .today { background: #eef6ff !important; font-weight: bold; }
        .today::after { content: "NOW"; font-size: 7px; position: absolute; top: 2px; right: 2px; background: var(--primary); color: white; padding: 1px 3px; border-radius: 2px; }
        
        .outside { background: #fafafa; color: #ccc; }

        .log-item { padding: 5px; border-radius: 0 3px 3px 0; margin-bottom: 4px; font-size: 9px; background: #fdfdfd; border-left: 3px solid #ccc; }
        .log-add { border-left-color: var(--event-green); }
        .log-delete { border-left-color: var(--delete-red); }

        .calendar-pill { background: var(--event-green); color: white; font-size: 9px; padding: 2px 5px; border-radius: 2px; margin-top: 2px; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .pill-tooltip { visibility: hidden; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 4px 8px; border-radius: 4px; white-space: nowrap; font-size: 9px; z-index: 2000; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .calendar-pill:hover .pill-tooltip { visibility: visible; opacity: 1; }
        .pill-delete { cursor: pointer; font-size: 11px; margin-left: 4px; }

        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.4); backdrop-filter: blur(1px); align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: white; padding: 15px; border-radius: 6px; width: 240px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border: 1px solid #ddd; }
        input, select { width: 100%; padding: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 3px; font-size: 10px; box-sizing: border-box;}
        button { cursor: pointer; border-radius: 3px; border: none; font-weight: 600; padding: 4px 10px; font-size: 10px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="calendar-section">
        <div class="notice-banner">
            <span>Please refresh the page to ensure it is up to date before filling a leave request.</span>
            <button class="refresh-btn" onclick="window.location.reload()">Refresh</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <a href="Dashboard.html" title="Agent PTO Summary" style="text-decoration: none;">
				<button style="background:var(--primary); color:white; cursor:pointer;">üè† DASHBOARD</button>
				</a>
                <div id="monthDisplay" class="month-display"></div>
				<div>
				<button onclick="changeMonth(-1)" style="background:var(--primary); color:white;">‚óÄÔ∏è</button>
                <button onclick="changeMonth(1)" style="background:var(--primary); color:white;">‚ñ∂Ô∏è</button>
				</div>
            </div>
            <div class="day-header">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendarGrid" class="days-grid"></div>
        </div>
        
        <div style="width:100%; text-align:center; margin-top:8px; color:#7f8c8d; font-size:9px;">
          <b>This calendar page was created to provide the team with clear visibility for scheduled PTO</b>
        </div>

        <div id="eventModal" class="modal">
            <div class="modal-content">
                <h3 style="margin-top:0; font-size: 12px;">Add Entry</h3>
                <input type="text" maxlength="6" id="eventTitle" placeholder="Name">
                <select id="eventShift">
                    <option value="" disabled selected>-- Select Shift --</option>
                    <option value="7 PM">7PM (8PM DST)</option>
                    <option value="8 PM">8PM (9PM DST)</option>
                    <option value="11 PM">11PM (12AM DST)</option>
                    <option value="1 AM">1AM (2AM DST)</option>
                    <option value="10 AM">10AM (11AM DST)</option>
                </select>
                <div id="valMsg" style="color:red; font-size:9px; display:none;">Missing fields!</div>
                <center><div id="limitMsg" style="color:red; font-size:9px; display:none;"></div><br></center>
                <div style="display:flex; justify-content:flex-end; gap:5px;">
                    <button onclick="closeModal('eventModal')">Cancel</button>
                    <button onclick="saveEvent()" style="background:var(--primary); color:white;">Save</button>
                </div>
            </div>
        </div>

        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h3 style="font-size:12px;">Delete?</h3>
                <p id="deletePromptText" style="color:#555;"></p>
                <div style="display:flex; justify-content:flex-end; gap:5px;">
                    <button onclick="closeModal('deleteModal')">Cancel</button>
                    <button id="confirmDeleteBtn" style="background:var(--delete-red); color:white;">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="event-pane">
        <div class="holiday-widget">
            <h4>Holidays (PH/US)</h4>
            <div id="holidayList">Loading...</div>
        </div>

        <div class="log-container">
            <div class="log-header">
                <h2 style="font-size: 11px; margin:0;">Activity Log <span style="font-size: 8px;">(MNL)</span></h2>
            </div>
            <div id="paneList"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAqqi6YTOIEhMOrkbE2zYT6W315S4wznog",
        authDomain: "web-app-8f476.firebaseapp.com",
        databaseURL: "https://web-app-8f476-default-rtdb.firebaseio.com",
        projectId: "web-app-8f476",
        storageBucket: "web-app-8f476.firebasestorage.app",
        messagingSenderId: "376213417562",
        appId: "1:376213417562:web:8e14ad690f4a2b6a07f263",
        measurementId: "G-N4N5BQ72WZ"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let dt = new Date();
    let activeEvents = {};
    let holidays = [];
    let selectedDateKey = "";

    async function fetchHolidays(year) {
        try {
            const [phRes, usRes] = await Promise.all([
                fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/PH`),
                fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/US`)
            ]);
            const phData = await phRes.json();
            const usData = await usRes.json();
            holidays = [
                ...phData.map(h => ({ date: h.date, name: h.name, country: 'PH' })),
                ...usData.map(h => ({ date: h.date, name: h.name, country: 'US' }))
            ];
            renderCalendar();
        } catch (e) { console.error("Fetch Error", e); }
    }

    db.ref('activeEvents').on('value', snap => { activeEvents = snap.val() || {}; renderCalendar(); });
    db.ref('permanentLog').on('value', snap => {
        const paneList = document.getElementById('paneList');
        paneList.innerHTML = '';
        const logs = snap.val() || {};
        Object.keys(logs).reverse().forEach(k => {
            const entry = logs[k];
            const div = document.createElement('div');
            div.className = `log-item ${entry.type==='ADD'?'log-add':'log-delete'}`;
            div.innerHTML = `<strong>${entry.type}: ${entry.title}</strong><br><span style="color:#888; font-size:8px;">${entry.timestamp_manila}</span>`;
            paneList.appendChild(div);
        });
    });

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
        const month = dt.getMonth(); const year = dt.getFullYear();
        document.getElementById('monthDisplay').innerText = dt.toLocaleDateString('en-us', { month: 'long', year: 'numeric' });
        const holidayListDiv = document.getElementById('holidayList');
        holidayListDiv.innerHTML = '';
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) grid.innerHTML += '<div class="day outside"></div>';
        
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const key = `${year}-${month+1}-${d}`;
            
            // GROUPING HOLIDAYS
            const dayHolidays = holidays.filter(h => h.date === dateStr);
            if(dayHolidays.length > 0) {
                const hasPH = dayHolidays.some(h => h.country === 'PH');
                const hasUS = dayHolidays.some(h => h.country === 'US');
                const holidayNames = [...new Set(dayHolidays.map(h => h.name))].join(' / ');

                const item = document.createElement('div'); 
                item.className = 'holiday-item';
                let countryLabel = "PH";
                if(hasPH && hasUS) countryLabel = "ALL";
                else if(hasUS) countryLabel = "US";
                
                item.innerHTML = `<b>${countryLabel}</b> <span>${d}: ${holidayNames}</span>`; 
                holidayListDiv.appendChild(item);
            }

            const div = document.createElement('div'); div.className = 'day'; div.innerHTML = `<strong>${d}</strong>`;
            if(d===new Date().getDate() && month===new Date().getMonth() && year===new Date().getFullYear()) div.classList.add('today');
            
            if(activeEvents[key]) {
                Object.keys(activeEvents[key]).forEach(id => {
                    const ev = activeEvents[key][id];
                    const p = document.createElement('div'); p.className = 'calendar-pill';
                    p.innerHTML = `<span>${ev.title}</span><div class="pill-tooltip">Shift: ${ev.shift}</div><span class="pill-delete" onclick="event.stopPropagation(); openDeleteModal('${key}','${id}','${ev.title}')">√ó</span>`;
                    div.appendChild(p);
                });
            }
            div.onclick = () => { 
                selectedDateKey = key; 
                document.getElementById('valMsg').style.display='none';
                document.getElementById('limitMsg').style.display='none';
                openModal('eventModal'); 
            };
            grid.appendChild(div);
        }
        if(holidayListDiv.innerHTML === '') holidayListDiv.innerHTML = '<div style="font-size:8px; color:#999;">No holidays</div>';
    }

    function openModal(id) { document.getElementById(id).style.display='flex'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    function saveEvent() {
        const t = document.getElementById('eventTitle'), s = document.getElementById('eventShift');
        const v = document.getElementById('valMsg'), l = document.getElementById('limitMsg');
        
        v.style.display='none';
        l.style.display='none';

        if(!t.value.trim() || !s.value) { v.style.display='block'; return; }

        const currentDayEvents = activeEvents[selectedDateKey] || {};
        let counts = { "7 PM": 0, "8 PM": 0, "11 PM": 0, "1 AM": 0, "10 AM": 0 };

        Object.values(currentDayEvents).forEach(ev => {
            if(counts.hasOwnProperty(ev.shift)) counts[ev.shift]++;
        });

        if(s.value === "7 PM" || s.value === "8 PM") {
            if((counts["7 PM"] + counts["8 PM"]) >= 2) { 
                l.innerText = "Only 2 leaves allowed across 7PM & 8PM shifts combined."; 
                l.style.display = 'block'; return; 
            }
        }
        if(s.value === "10 AM" && counts["10 AM"] >= 1) {
            l.innerText = "Only 1 leave allowed for the 10 AM shift.";
            l.style.display = 'block'; return;
        }
        if(s.value === "11 PM" && counts["11 PM"] >= 1) {
            l.innerText = "Only 1 leave allowed for the 11 PM shift.";
            l.style.display = 'block'; return;
        }
        if(s.value === "1 AM" && counts["1 AM"] >= 1) {
            l.innerText = "Only 1 leave allowed for the 1 AM shift.";
            l.style.display = 'block'; return;
        }

        db.ref('activeEvents/'+selectedDateKey).push({ title: t.value, shift: s.value });
        db.ref('permanentLog').push({ type: 'ADD', title: t.value, timestamp_manila: new Date().toLocaleString('en-US', {timeZone: 'Asia/Manila'}), timestamp_raw: Date.now() });
        t.value=''; s.selectedIndex=0; closeModal('eventModal');
    }

    function openDeleteModal(k, i, t) {
        document.getElementById('deletePromptText').innerText = `Remove ${t}?`;
        document.getElementById('deleteModal').style.display='flex';
        document.getElementById('confirmDeleteBtn').onclick = () => {
            db.ref(`activeEvents/${k}/${i}`).remove();
            db.ref('permanentLog').push({ type: 'DELETE', title: t, timestamp_manila: new Date().toLocaleString('en-US', {timeZone: 'Asia/Manila'}), timestamp_raw: Date.now() });
            closeModal('deleteModal');
        };
    }

    function changeMonth(v) { dt.setMonth(dt.getMonth()+v); fetchHolidays(dt.getFullYear()); }
    fetchHolidays(dt.getFullYear());
</script>
</body>
</html>











